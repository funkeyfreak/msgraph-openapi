# Checks for an update to the schema. If one exists, update our repo

name: checkandupdate

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    outputs: 
      diff: false
    steps:
      - uses: actions/checkout@v2

      - name: Setup Environment
        run: npm install

      - name: Download v1 Swagger 2.0 Definition
        run: wget -O src/v1/swagger.yaml "https://graphslice.azurewebsites.net/openapi?operationIds=*&openApiVersion=2&graphVersion=v1.0"

      - name: Download beta Swagger 2.0 Definition
        run: wget -O src/beta/swagger.yaml "https://graphslice.azurewebsites.net/openapi?operationIds=*&openApiVersion=2&graphVersion=beta"

      - name: Convert v1 Swagger 2.0 to OpenAPI 3.0 Definition
        run: ./node_modules/.bin/swagger2openapi -p -o src/v1/openapi.yaml src/v1/swagger.yaml

      - name: Convert beta Swagger 2.0 to OpenAPI 3.0 Definition
        run: ./node_modules/.bin/swagger2openapi -p -o src/beta/openapi.yaml src/beta/swagger.yaml

      - name: Check Diff
        id: git-diff
        run: echo ::set-output name=diff::${{ git diff --name-only src/**/*.yaml }}
        #uses: technote-space/get-diff-action@gh-actions
        #with:
        #  PATTERNS: |
        #    src/**/*.yaml

  update:
    runs-on: ubuntu-latest
    needs: check
    steps:
      - name: Commit Changes
        if: needs.check.git-diff.outputs.diff
        run: |
          branch="release-$(uuidgen)"
          git checkout -b $branch
          git add src/**/*.yaml
          git commit -m "updating openapi and swagger files"
          git push -u origin $branch

    #- name: Create Pull Request
    #if: steps.git-diff.outputs.diff
    #uses: peter-evans/create-pull-request@v3
    #with:
    #  commit-message: "updating openapi and swagger files"
    #  title: "Updating MSGraph's Swagger and OpenAPI Files"
